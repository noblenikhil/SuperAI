<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noble OneAI | Ultimate Super Agent</title>

    <!-- Dependencies -->
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Rich Content Engines -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --bg: #09090b;
            --sidebar: #020203;
            --accent: linear-gradient(135deg, #60a5fa 0%, #c084fc 100%);
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg);
            color: #fafafa;
            font-family: 'Georgia', serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* Typography */
        .font-georgia { font-family: 'Georgia', serif; }
        .font-roboto { font-family: 'Roboto Mono', monospace !important; }
        .font-sans { font-family: 'Inter', sans-serif; }

        /* Welcome Screen Gradient */
        .welcome-gradient {
            background: var(--accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            filter: drop-shadow(0 0 20px rgba(96, 165, 250, 0.3));
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 15, 20, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
        }

        .glass-card {
            background: var(--glass);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(96, 165, 250, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Sidebar Styling */
        #sidebar {
            width: 320px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-item {
            border-radius: 12px;
            padding: 10px 14px;
            margin: 4px 0;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-item:hover { background: rgba(255,255,255,0.05); }
        .sidebar-item.active { background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.2); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        /* Input Terminal */
        #input-wrapper {
            transition: all 0.3s ease;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }

        #chat-input {
            min-height: 60px;
            max-height: 350px;
            line-height: 1.6;
        }

        /* Markdown & Code Blocks */
        .prose pre {
            background: #0d0d0f !important;
            border: 1px solid #1f1f23;
            border-radius: 14px;
            padding: 1.25rem !important;
            margin: 1.5rem 0;
            position: relative;
        }

        .prose code { color: #93c5fd; font-family: 'Roboto Mono', monospace !important; font-size: 0.9em; }

        /* Auth Gate */
        #auth-gate {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: #020203;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .loader-dot { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    </style>
</head>
<body>

    <!-- Access Control Layer -->
    <div id="auth-gate" class="font-sans">
        <div class="glass-panel p-12 rounded-[2.5rem] w-full max-w-md text-center space-y-8 border-white/5 shadow-2xl">
            <div class="space-y-2">
                <h1 class="text-4xl font-bold welcome-gradient tracking-tighter">Noble OneAI</h1>
                <p class="text-zinc-500 text-sm">SECURE TERMINAL ACCESS</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="pin-field" placeholder="••••••" class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl text-center text-3xl tracking-[0.5em] focus:border-blue-500/50 outline-none transition-all">
                <button onclick="attemptAccess()" class="w-full bg-white text-black font-bold py-5 rounded-2xl hover:scale-[1.02] active:scale-95 transition-all text-lg shadow-xl shadow-white/5">Unlock Interface</button>
                <button onclick="alert('Access Hint: Pin is 392001')" class="text-[10px] text-zinc-600 uppercase tracking-widest hover:text-zinc-400">Request Credentials Hint</button>
            </div>
        </div>
    </div>

    <!-- Sidebar: Intelligence Library -->
    <aside id="sidebar" class="font-sans">
        <div class="p-6 border-b border-white/5 flex justify-between items-center">
            <div>
                <h2 class="font-bold text-xl tracking-tight">Noble OneAI</h2>
                <p class="text-[10px] text-blue-500 font-bold uppercase tracking-[0.2em]">Super Agent v4.5</p>
            </div>
            <div class="flex gap-1">
                <button onclick="createNewFolder()" class="p-2 hover:bg-white/5 rounded-lg text-zinc-400" title="New Folder"><i data-lucide="folder-plus" class="w-4"></i></button>
                <button onclick="startNewChat()" class="p-2 bg-blue-600/10 text-blue-400 border border-blue-500/20 hover:bg-blue-600/20 rounded-lg" title="New Chat"><i data-lucide="plus" class="w-4"></i></button>
            </div>
        </div>

        <!-- Chat History Scroll Area -->
        <div id="sidebar-scroll" class="flex-1 overflow-y-auto p-4 space-y-6">
            <div id="folders-container" class="space-y-4">
                <!-- Folders and their chats injected here -->
            </div>
            <div id="root-chats-container" class="space-y-1">
                <h3 class="text-[10px] text-zinc-600 uppercase tracking-widest mb-3 px-2">Library History</h3>
                <!-- Lone chats injected here -->
            </div>
        </div>

        <!-- User Profile Footer -->
        <div class="p-5 border-t border-white/5 bg-black/20">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg">N</div>
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm truncate">Nikhil</p>
                    <p class="text-[10px] text-zinc-500 uppercase tracking-tighter">Verified System Owner</p>
                </div>
                <button onclick="systemShutdown()" class="text-zinc-600 hover:text-red-400 transition-colors"><i data-lucide="log-out" class="w-4"></i></button>
            </div>
        </div>
    </aside>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col relative bg-[#09090b]">
        
        <!-- Glass Navigation -->
        <nav class="h-20 glass-panel flex items-center justify-between px-10 z-50">
            <div class="flex items-center gap-8">
                <button onclick="toggleSidebar()" class="text-zinc-500 hover:text-white transition-transform hover:scale-110"><i data-lucide="layout-sidebar" class="w-5"></i></button>
                <div class="h-6 w-[1px] bg-white/10"></div>
                
                <div class="flex flex-col">
                    <span class="text-[10px] text-zinc-500 uppercase tracking-[0.2em] mb-1">Active Neural Engine</span>
                    <select id="engine-select" class="bg-transparent text-sm font-sans font-semibold focus:outline-none cursor-pointer border-none text-zinc-200" onchange="updateEngineStatus()">
                        <optgroup label="Logic & Coding">
                            <option value="claude-3-5-sonnet" selected>Claude 3.5 Sonnet (Elite Code)</option>
                            <option value="google/gemini-1.5-pro-preview-0514">Gemini 1.5 Pro (Deep Reasoning)</option>
                            <option value="claude-3-opus">Claude Opus (Creative Logic)</option>
                        </optgroup>
                        <optgroup label="Research & Web">
                            <option value="perplexity/sonar-deep-research">Perplexity Deep Research (Live Web)</option>
                        </optgroup>
                        <optgroup label="Media Generation">
                            <option value="black-forest-labs/FLUX.1-pro">FLUX.1.1 Pro (Image Synth)</option>
                            <option value="ByteDance/Seedance-1.0-pro">Seedance 1.0 (Video Synth)</option>
                        </optgroup>
                        <optgroup label="Advanced Utilities">
                            <option value="gpt-4o-transcribe-diarize">Transcription (STT Engine)</option>
                            <option value="elevenlabs">ElevenLabs (Human TTS)</option>
                            <option value="amazon-textract">Textract (Multilingual OCR)</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-6 font-sans">
                <div id="cloud-status" class="flex items-center gap-2 text-[10px] text-zinc-500 uppercase tracking-widest bg-white/5 px-3 py-1.5 rounded-full">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full shadow-[0_0_10px_rgba(34,197,94,0.5)]"></span> Puter Linked
                </div>
            </div>
        </nav>

        <!-- Dynamic Content Flow -->
        <div id="scroll-container" class="flex-1 overflow-y-auto">
            
            <!-- Default Home View -->
            <div id="home-view" class="h-full flex flex-col items-center justify-center p-10 space-y-12">
                <div class="text-center space-y-4">
                    <h1 class="text-8xl font-bold welcome-gradient tracking-tighter">Welcome Nikhil</h1>
                    <p class="text-zinc-500 text-xl max-w-2xl mx-auto font-sans font-light leading-relaxed">
                        Accessing the world's most advanced AI models via Noble OneAI's unified neural interface. 
                        Your session is secured and data-persistent.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 max-w-6xl w-full font-sans">
                    <div class="glass-card p-6 rounded-3xl space-y-4 cursor-pointer" onclick="quickSelect('claude-3-5-sonnet')">
                        <div class="w-12 h-12 bg-blue-500/10 rounded-2xl flex items-center justify-center text-blue-400"><i data-lucide="code"></i></div>
                        <h4 class="font-bold">Code Master</h4>
                        <p class="text-xs text-zinc-500">Architecture-level debugging with Claude 3.5 Sonnet.</p>
                    </div>
                    <div class="glass-card p-6 rounded-3xl space-y-4 cursor-pointer" onclick="quickSelect('perplexity/sonar-deep-research')">
                        <div class="w-12 h-12 bg-purple-500/10 rounded-2xl flex items-center justify-center text-purple-400"><i data-lucide="globe"></i></div>
                        <h4 class="font-bold">Live Research</h4>
                        <p class="text-xs text-zinc-500">Scientific discovery with real-time Perplexity web access.</p>
                    </div>
                    <div class="glass-card p-6 rounded-3xl space-y-4 cursor-pointer" onclick="quickSelect('black-forest-labs/FLUX.1-pro')">
                        <div class="w-12 h-12 bg-orange-500/10 rounded-2xl flex items-center justify-center text-orange-400"><i data-lucide="palette"></i></div>
                        <h4 class="font-bold">Art Synth</h4>
                        <p class="text-xs text-zinc-500">High-fidelity image generation with FLUX.1.1 Pro.</p>
                    </div>
                    <div class="glass-card p-6 rounded-3xl space-y-4 cursor-pointer" onclick="quickSelect('amazon-textract')">
                        <div class="w-12 h-12 bg-green-500/10 rounded-2xl flex items-center justify-center text-green-400"><i data-lucide="scan-text"></i></div>
                        <h4 class="font-bold">OCR Engine</h4>
                        <p class="text-xs text-zinc-500">Multilingual document parsing via Textract.</p>
                    </div>
                </div>
            </div>

            <!-- Message Thread -->
            <div id="chat-thread" class="hidden w-full max-w-5xl mx-auto py-16 px-8 space-y-12">
                <!-- Messages render here -->
            </div>
        </div>

        <!-- Master Input Terminal -->
        <div id="input-wrapper" class="p-8 bg-gradient-to-t from-[#020203] to-transparent">
            <div class="max-w-5xl mx-auto space-y-4">
                <div class="glass-panel p-2 rounded-[2rem] flex items-end gap-2 border-white/10 shadow-2xl relative">
                    
                    <input type="file" id="media-upload" class="hidden" multiple onchange="handleFileUpload(this.files)">
                    <button onclick="document.getElementById('media-upload').click()" class="p-5 text-zinc-500 hover:text-white transition-colors" title="Attach Media/Docs">
                        <i data-lucide="plus" class="w-6"></i>
                    </button>
                    
                    <textarea id="chat-input" rows="1" 
                        class="flex-1 bg-transparent border-none outline-none p-5 text-xl font-georgia resize-none custom-scrollbar" 
                        placeholder="Neural prompt here..."></textarea>
                    
                    <button id="send-trigger" class="bg-white text-black p-5 rounded-[1.5rem] hover:bg-blue-50 transition-all disabled:opacity-20 shadow-lg shadow-white/5">
                        <i data-lucide="arrow-up" class="w-6"></i>
                    </button>
                </div>
                
                <div class="flex justify-between items-center px-6">
                    <div class="flex gap-4">
                        <p class="text-[10px] text-zinc-600 uppercase tracking-[0.3em] font-sans">Ctrl + Enter to Execute</p>
                    </div>
                    <div id="typing-indicator" class="hidden text-[10px] text-blue-400 uppercase tracking-[0.3em] font-sans flex items-center gap-2">
                        <span class="loader-dot">●</span> Processing Query...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- SYSTEM CONFIG ---
        const PIN_CODE = "392001";
        const CLOUDINARY_API = "https://api.cloudinary.com/v1_1/dgpixx6j7/auto/upload";
        const CLOUDINARY_PRESET = "SuperAi interface";
        const STORAGE_KEY = 'noble_oneai_system_v5';

        // --- CORE STATE ---
        let appState = {
            chats: [],
            folders: [],
            activeChat: null,
            isGenerating: false
        };

        // --- BOOT SEQUENCE ---
        window.onload = () => {
            lucide.createIcons();
            initInputSystem();
        };

        async function attemptAccess() {
            const pin = document.getElementById('pin-field').value;
            if(pin === PIN_CODE) {
                document.getElementById('auth-gate').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('auth-gate').style.display = 'none';
                    syncAndBoot();
                }, 500);
            } else {
                alert("ACCESS DENIED: Credentials Invalid.");
            }
        }

        async function syncAndBoot() {
            try {
                // Try Puter Cloud first
                const cloudData = await puter.fs.read('noble_one_system.json');
                appState = JSON.parse(cloudData);
            } catch (e) {
                // Fallback to local
                const localData = localStorage.getItem(STORAGE_KEY);
                if(localData) appState = JSON.parse(localData);
            }
            refreshSidebar();
        }

        async function commitState() {
            const data = JSON.stringify(appState);
            localStorage.setItem(STORAGE_KEY, data);
            try { await puter.fs.write('noble_one_system.json', data); } catch(e) {}
        }

        // --- CONVERSATION ENGINE ---
        async function startNewChat(folderId = null) {
            const newChat = {
                id: 'chat-' + Date.now(),
                title: "New Transmission",
                messages: [],
                folderId: folderId,
                engine: document.getElementById('engine-select').value,
                created: new Date().toISOString()
            };
            appState.chats.unshift(newChat);
            openChat(newChat.id);
            commitState();
        }

        function openChat(id) {
            appState.activeChat = id;
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('chat-thread').classList.remove('hidden');
            renderDialogue();
            refreshSidebar();
        }

        async function executeNeuralCall() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            const engine = document.getElementById('engine-select').value;
            
            if(!prompt || appState.isGenerating) return;
            if(!appState.activeChat) await startNewChat();

            const chat = appState.chats.find(c => c.id === appState.activeChat);
            
            // Add User Prompt
            chat.messages.push({ role: 'user', content: prompt, type: 'text', timestamp: new Date().toLocaleTimeString() });
            input.value = '';
            input.style.height = 'auto';
            renderDialogue();
            
            // UI State
            appState.isGenerating = true;
            document.getElementById('typing-indicator').classList.remove('hidden');
            document.getElementById('send-trigger').disabled = true;

            // First Message Title Gen
            if(chat.messages.length === 1) autoTitle(chat, prompt);

            try {
                // Prepare AI slot
                const aiMsg = { role: 'assistant', content: '', timestamp: new Date().toLocaleTimeString() };
                chat.messages.push(aiMsg);
                const bubble = renderDialogue(true); // Last bubble target

                let responseContent = "";

                // --- THE MODEL GATEWAY (Correctly formatted per API) ---
                if(engine.includes('FLUX')) {
                    const res = await puter.ai.txt2img(prompt);
                    const cloudUrl = await uploadToCloudinary(res.src);
                    responseContent = `![Generated Image](${cloudUrl})`;
                } 
                else if(engine.includes('Seedance')) {
                    const res = await puter.ai.txt2vid(prompt);
                    const cloudUrl = await uploadToCloudinary(res.src);
                    responseContent = `Video Generated: \n\n <video src="${cloudUrl}" controls class="w-full rounded-3xl border border-white/5"></video>`;
                }
                else if(engine === 'elevenlabs') {
                    const res = await puter.ai.tts(prompt); 
                    const cloudUrl = await uploadToCloudinary(res.src);
                    responseContent = `Audio synthesized successfully: \n\n <audio src="${cloudUrl}" controls class="w-full"></audio>`;
                }
                else {
                    // Standard LLM Call (Contextual)
                    const history = chat.messages.slice(0, -1).map(m => ({ role: m.role, content: m.content }));
                    const res = await puter.ai.chat(history, { model: engine });
                    responseContent = res.message.content;
                }

                await typewriterEffect(bubble, responseContent, aiMsg);
                commitState();

            } catch (err) {
                console.error("GATEWAY ERROR:", err);
                chat.messages[chat.messages.length - 1].content = "### ⚠️ Neural Gateway Error\nCould not connect to the engine. Details: " + err.message;
                renderDialogue();
            } finally {
                appState.isGenerating = false;
                document.getElementById('typing-indicator').classList.add('hidden');
                document.getElementById('send-trigger').disabled = false;
            }
        }

        async function autoTitle(chat, prompt) {
            try {
                const res = await puter.ai.chat(`Give a 3-word title for: "${prompt}". Return ONLY the title.`, { model: 'gpt-4o-mini' });
                chat.title = res.message.content.replace(/"/g, '');
                refreshSidebar();
            } catch(e) {}
        }

        // --- UI RENDERING CORE ---
        function renderDialogue(isPartial = false) {
            const thread = document.getElementById('chat-thread');
            thread.innerHTML = '';
            const chat = appState.chats.find(c => c.id === appState.activeChat);
            if(!chat) return;

            chat.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} fade-in group`;
                
                const bubbleHtml = `
                    <div class="max-w-[85%] space-y-2">
                        <div class="flex items-center gap-3 font-sans ${msg.role === 'user' ? 'flex-row-reverse' : ''}">
                             <span class="text-[10px] font-bold text-zinc-600 uppercase tracking-widest">${msg.role}</span>
                             <span class="text-[10px] text-zinc-800">${msg.timestamp}</span>
                        </div>
                        <div class="p-8 rounded-[2rem] ${msg.role === 'user' ? 'bg-[#18181b] border border-white/10 text-zinc-100' : 'bg-transparent text-white border-l-2 border-blue-500/30'}">
                            <div class="prose prose-invert max-w-none text-xl leading-[1.8] font-georgia message-content">
                                ${marked.parse(msg.content)}
                            </div>
                            ${msg.role === 'assistant' ? `
                                <div class="mt-8 flex gap-4 opacity-0 group-hover:opacity-100 transition-all border-t border-white/5 pt-4">
                                    <button onclick="copyMsg(this)" class="text-[10px] uppercase tracking-widest font-bold text-zinc-600 hover:text-white flex items-center gap-2"><i data-lucide="copy" class="w-3"></i> Copy</button>
                                    <button onclick="downloadMsg(this)" class="text-[10px] uppercase tracking-widest font-bold text-zinc-600 hover:text-white flex items-center gap-2"><i data-lucide="download" class="w-3"></i> Export</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                div.innerHTML = bubbleHtml;
                thread.appendChild(div);
            });

            // Post Processing: Highlighting & KaTeX
            document.querySelectorAll('pre code').forEach(el => {
                el.classList.add('font-roboto');
                hljs.highlightElement(el);
                injectCodeTools(el);
            });
            renderMathInElement(thread);
            lucide.createIcons();
            
            const scroller = document.getElementById('scroll-container');
            scroller.scrollTop = scroller.scrollHeight;
            
            return thread.lastElementChild?.querySelector('.message-content');
        }

        async function typewriterEffect(target, text, msgRef) {
            let i = 0;
            const chunkSize = 5;
            return new Promise(resolve => {
                function frame() {
                    if (i < text.length) {
                        i += chunkSize;
                        target.innerHTML = marked.parse(text.substring(0, i) + "█");
                        document.getElementById('scroll-container').scrollTop = document.getElementById('scroll-container').scrollHeight;
                        requestAnimationFrame(frame);
                    } else {
                        target.innerHTML = marked.parse(text);
                        msgRef.content = text;
                        resolve();
                    }
                }
                frame();
            });
        }

        // --- SIDEBAR & LIBRARY ---
        function refreshSidebar() {
            const fContainer = document.getElementById('folders-container');
            const rContainer = document.getElementById('root-chats-container');
            fContainer.innerHTML = '';
            rContainer.innerHTML = `<h3 class="text-[10px] text-zinc-600 uppercase tracking-widest mb-3 px-2">Library History</h3>`;

            // Render Folders
            appState.folders.forEach(folder => {
                const fDiv = document.createElement('div');
                fDiv.className = "space-y-1";
                fDiv.innerHTML = `
                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-white/5 cursor-pointer group text-zinc-400">
                        <div class="flex items-center gap-3">
                            <i data-lucide="folder" class="w-4 text-blue-500"></i>
                            <span class="font-bold tracking-tight">${folder.name}</span>
                        </div>
                        <div class="hidden group-hover:flex gap-1">
                            <button onclick="deleteFolder('${folder.id}')" class="p-1 hover:text-red-400"><i data-lucide="trash-2" class="w-3"></i></button>
                        </div>
                    </div>
                    <div class="ml-4 border-l border-white/5 pl-2 space-y-1" id="f-${folder.id}"></div>
                `;
                fContainer.appendChild(fDiv);
                
                const box = fContainer.querySelector(`#f-${folder.id}`);
                appState.chats.filter(c => c.folderId === folder.id).forEach(chat => box.appendChild(createChatIcon(chat)));
            });

            // Render Root
            appState.chats.filter(c => !c.folderId).forEach(chat => rContainer.appendChild(createChatIcon(chat)));
            lucide.createIcons();
        }

        function createChatIcon(chat) {
            const div = document.createElement('div');
            div.className = `sidebar-item group ${appState.activeChat === chat.id ? 'active' : ''}`;
            div.onclick = () => openChat(chat.id);
            div.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <i data-lucide="message-square" class="w-4 text-zinc-600 shrink-0"></i>
                    <span class="truncate">${chat.title}</span>
                </div>
                <div class="hidden group-hover:flex gap-2 text-zinc-500">
                    <button onclick="event.stopPropagation(); moveChatPrompt('${chat.id}')"><i data-lucide="move" class="w-3 hover:text-white"></i></button>
                    <button onclick="event.stopPropagation(); deleteChat('${chat.id}')"><i data-lucide="x" class="w-3 hover:text-red-400"></i></button>
                </div>
            `;
            return div;
        }

        // --- UTILITIES ---
        function createNewFolder() {
            const name = prompt("Folder Name:");
            if(name) {
                appState.folders.push({ id: 'f-' + Date.now(), name });
                commitState(); refreshSidebar();
            }
        }

        function moveChatPrompt(chatId) {
            if(!appState.folders.length) return alert("Create a folder first!");
            const list = appState.folders.map((f, i) => `${i}: ${f.name}`).join('\n');
            const choice = prompt(`Select Folder Index (or 'none' to un-folder):\n${list}`);
            const chat = appState.chats.find(c => c.id === chatId);
            if(choice === 'none') chat.folderId = null;
            else if(appState.folders[choice]) chat.folderId = appState.folders[choice].id;
            commitState(); refreshSidebar();
        }

        async function uploadToCloudinary(file) {
            let blob = file;
            if(typeof file === 'string' && file.startsWith('blob:')) {
                blob = await fetch(file).then(r => r.blob());
            }
            const fd = new FormData();
            fd.append('file', blob);
            fd.append('upload_preset', CLOUDINARY_PRESET);
            const res = await fetch(CLOUDINARY_API, { method: 'POST', body: fd });
            const data = await res.json();
            return data.secure_url;
        }

        async function handleFileUpload(files) {
            if(!appState.activeChat) await startNewChat();
            const chat = appState.chats.find(c => c.id === appState.activeChat);

            for(let f of files) {
                const url = await uploadToCloudinary(f);
                let content = `Uploaded File: [${f.name}](${url})`;
                if(f.type.includes('image')) content = `![${f.name}](${url})`;
                else if(f.type.includes('video')) content = `<video src="${url}" controls class="w-full rounded-3xl"></video>`;
                
                chat.messages.push({ role: 'user', content, timestamp: new Date().toLocaleTimeString() });
            }
            renderDialogue();
            commitState();
        }

        function initInputSystem() {
            const area = document.getElementById('chat-input');
            area.addEventListener('input', () => {
                area.style.height = 'auto';
                area.style.height = area.scrollHeight + 'px';
            });
            area.addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    executeNeuralCall();
                }
            });
            document.getElementById('send-trigger').onclick = executeNeuralCall;
        }

        function injectCodeTools(code) {
            const pre = code.parentElement;
            const b = document.createElement('button');
            b.className = "absolute top-4 right-4 p-2 bg-white/5 rounded-lg text-[10px] font-bold text-zinc-500 hover:text-white border border-white/5";
            b.innerText = "COPY";
            b.onclick = () => {
                navigator.clipboard.writeText(code.innerText);
                b.innerText = "COPIED";
                setTimeout(() => b.innerText = "COPY", 2000);
            };
            pre.appendChild(b);
        }

        function renderMathInElement(el) {
            try {
                renderMathInElement(el, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError : false
                });
            } catch(e) {}
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebar');
            s.style.transform = s.style.transform === 'translateX(-100%)' ? 'translateX(0)' : 'translateX(-100%)';
            if(!s.style.transform) s.style.width = s.style.width === '0px' ? '320px' : '0px';
        }

        function quickSelect(model) {
            document.getElementById('engine-select').value = model;
            updateEngineStatus();
        }

        function updateEngineStatus() {
            const select = document.getElementById('engine-select');
            const name = select.options[select.selectedIndex].text;
            console.log("Switching to Engine:", name);
        }

        function deleteChat(id) {
            if(confirm("Delete this dialogue permanently?")) {
                appState.chats = appState.chats.filter(c => c.id !== id);
                if(appState.activeChat === id) appState.activeChat = null;
                commitState(); refreshSidebar();
                if(!appState.activeChat) location.reload();
            }
        }

        function systemShutdown() {
            if(confirm("Logout and Wipe Local Session? (Cloud data remains)")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function copyMsg(btn) {
            const text = btn.closest('.fade-in').querySelector('.message-content').innerText;
            navigator.clipboard.writeText(text);
            btn.innerText = "COPIED";
            setTimeout(() => btn.innerText = "COPY", 2000);
        }
        
        function downloadMsg(btn) {
            const text = btn.closest('.fade-in').querySelector('.message-content').innerText;
            const blob = new Blob([text], {type: 'text/markdown'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `noble-export-${Date.now()}.md`;
            a.click();
        }
    </script>
</body>
</html>
